% Define velocity of freestream
V0 = 8;
rho = 1.1716;

% Define a yawed rotor
R = 126.4/2;
yaw = 20/180*pi;

% Define cp and ct lookup table for NREL5MW
cp = [0 0.192600000000000 0.230500000000000 0.262600000000000 0.289800000000000 0.312900000000000 0.332500000000000 0.349400000000000 0.364000000000000 0.376800000000000 0.387600000000000 0.397300000000000 0.405700000000000 0.413100000000000 0.419600000000000 0.425400000000000 0.430500000000000 0.435300000000000 0.439200000000000 0.442900000000000 0.446300000000000 0.449000000000000 0.451500000000000 0.453900000000000 0.455700000000000 0.457200000000000 0.458600000000000 0.459900000000000 0.461000000000000 0.461600000000000 0.462100000000000 0.462600000000000 0.463100000000000 0.463500000000000 0.463700000000000 0.463600000000000 0.463400000000000 0.463300000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463200000000000 0.463000000000000 0.462800000000000 0.462000000000000 0.461000000000000 0.460000000000000 0.459000000000000 0.458000000000000 0.460300000000000 0.460200000000000 0.452200000000000 0.444400000000000 0.436800000000000 0.429300000000000 0.421900000000000 0.414600000000000 0.407400000000000 0.400400000000000 0.393500000000000 0.386700000000000 0.380100000000000 0.373500000000000 0.367100000000000 0.360800000000000 0.354600000000000 0.348500000000000 0.342400000000000 0.336500000000000 0.330800000000000 0.325100000000000 0.319500000000000 0.313900000000000 0.308500000000000 0.303200000000000 0.298000000000000 0.292900000000000 0.287800000000000 0.282900000000000 0.278000000000000 0.273200000000000 0.268500000000000 0.263900000000000 0.259300000000000 0.254800000000000 0.250500000000000 0.246100000000000 0.241900000000000 0.237700000000000 0.233600000000000 0.229600000000000 0.225700000000000 0.221800000000000 0.217900000000000 0.214200000000000 0.210500000000000 0.206900000000000 0.203300000000000 0.199800000000000 0.196400000000000 0.193000000000000 0.189700000000000 0.186400000000000 0.183200000000000 0.180000000000000 0.176900000000000 0.173900000000000 0.170900000000000 0.167900000000000 0.165000000000000 0.162200000000000 0.159400000000000 0.156700000000000 0.154000000000000 0.151300000000000 0.148700000000000 0.146100000000000 0.143600000000000 0.141100000000000 0.138700000000000 0.136300000000000 0.134000000000000 0.131700000000000 0.129400000000000 0.127200000000000 0.125000000000000 0.122800000000000 0.120700000000000 0.118600000000000 0.116600000000000 0.114600000000000 0.112600000000000 0.110700000000000 0.108800000000000 0.106900000000000 0.105000000000000 0.103200000000000 0.101400000000000 0.0997000000000000 0.0980000000000000 0.0963000000000000 0.0946000000000000 0.0930000000000000 0.0914000000000000 0.0898000000000000 0.0883000000000000 0.0868000000000000 0.0853000000000000 0.0838000000000000 0.0824000000000000 0.0809000000000000 0.0795000000000000 0.0782000000000000 0.0768000000000000 0.0755000000000000 0.0742000000000000 0.0729000000000000 0.0717000000000000 0.0704000000000000 0.0692000000000000 0.0680000000000000 0.0669000000000000 0.0657000000000000 0.0646000000000000 0.0635000000000000 0.0624000000000000 0.0613000000000000 0.0602000000000000 0.0592000000000000 0.0582000000000000 0.0572000000000000 0.0562000000000000 0.0552000000000000 0.0543000000000000 0.0533000000000000 0.0524000000000000 0.0515000000000000 0.0506000000000000 0.0497000000000000 0.0489000000000000 0.0480000000000000 0.0472000000000000 0.0464000000000000 0.0464000000000000];
ct = [0.0667202578680764 1.09515806677794 1.07569348775569 1.05706909849279 1.03938061952777 1.02271219886033 1.00703507538061 0.992286610876660 0.978410099454675 0.965360638452407 0.952937421660306 0.941248738156449 0.930169824348808 0.919648701045909 0.909683093696713 0.900201545885742 0.891167097267694 0.882666105933416 0.874388069634761 0.866609451050221 0.859201076041012 0.851904700530681 0.845028064446392 0.838542300440183 0.832056423373992 0.825790251992776 0.819870400621916 0.814274860465439 0.808812896195466 0.803282286378202 0.798048423590371 0.793093723005730 0.788401913415942 0.783957917512722 0.779511441115224 0.775029078930996 0.770781040196986 0.766754686043746 0.762938229623112 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.762092994013926 0.756807121270288 0.750832410072372 0.744424356717656 0.737960903113344 0.731647889023054 0.725480122557056 0.719452648014913 0.712822599475332 0.712118141675397 0.672106741728536 0.644009601964816 0.621017055548922 0.600880428495763 0.582557739887126 0.565602715217039 0.550223949819050 0.535482544218193 0.521885041318339 0.508764893672955 0.496533782315714 0.484615539071653 0.473518668684181 0.462379546193842 0.451864174046393 0.441657822004907 0.431787576812758 0.422413672820759 0.413203904851841 0.404425523619314 0.395937207742372 0.387598605000932 0.379710393364867 0.372003280444895 0.364432579044559 0.357289552121803 0.350217683379926 0.342991467243669 0.336180372983218 0.329489659090578 0.322909278827291 0.316631526661833 0.310498743670463 0.304467083655235 0.298666466208968 0.293045316899680 0.287519523187978 0.282148346589984 0.276998648097600 0.271938362337720 0.266966857272558 0.262155830317339 0.257153408957631 0.252278754006133 0.247565945484258 0.242998645704007 0.238496573280367 0.234079838709395 0.229869090241408 0.225729679386083 0.221661357237520 0.217728332954553 0.213924651303585 0.210189473334115 0.206522588199494 0.203035227977201 0.199615779030105 0.196262675435776 0.192636127752903 0.189158685553808 0.185737307716811 0.182371821802141 0.179134839863208 0.175971189723062 0.172862453233749 0.169821702030608 0.166905984506023 0.164044071660022 0.161236281232007 0.158524498434273 0.155900952974817 0.153330976042172 0.150814574196391 0.148419025502060 0.146079350956703 0.143792885446725 0.141194564299303 0.138692273984274 0.136229878093391 0.133809603846888 0.131466662038180 0.129189888810896 0.126954149889612 0.124757838137854 0.122662004412898 0.120600722466794 0.118588825998653 0.116639895515676 0.114759679565866 0.112922156853241 0.111127273617193 0.109415992855927 0.107752345402047 0.106131248729935 0.104568524185239 0.103074450915780 0.101295835974880 0.0994764664247799 0.0977209910268907 0.0960042281557158 0.0943196058348023 0.0926748570354335 0.0910895821433151 0.0895379046192655 0.0880187958316336 0.0865549340409081 0.0851347495241387 0.0837484610369282 0.0824012457377649 0.0811120696526988 0.0798570935277747 0.0786354601071859 0.0774681857957364 0.0763437362743874 0.0752521706012510 0.0742013328024543 0.0732048904983263 0.0722411076877503 0.0713103924100099 0.0700466841750141 0.0687862084287065 0.0675488011602301 0.0663426976929233 0.0651761196815344 0.0640330911143256 0.0629136150084708 0.0618400159144371 0.0607933775017852 0.0597706069218655 0.0587811218364905 0.0578350517992529 0.0600359335411413 0.0600359335411413];
wind_speed = [2.99000000000000 3 3.13080000000000 3.26170000000000 3.39250000000000 3.52340000000000 3.65420000000000 3.78510000000000 3.91590000000000 4.04680000000000 4.17760000000000 4.30850000000000 4.43930000000000 4.57020000000000 4.70100000000000 4.83190000000000 4.96270000000000 5.09350000000000 5.22440000000000 5.35520000000000 5.48610000000000 5.61690000000000 5.74780000000000 5.87860000000000 6.00950000000000 6.14030000000000 6.27120000000000 6.40200000000000 6.53290000000000 6.66370000000000 6.79460000000000 6.92540000000000 7.05620000000000 7.18710000000000 7.31790000000000 7.44880000000000 7.57960000000000 7.71050000000000 7.84130000000000 7.97220000000000 8.10300000000000 8.23390000000000 8.36470000000000 8.49560000000000 8.62640000000000 8.75730000000000 8.88810000000000 9.01890000000000 9.14980000000000 9.28060000000000 9.41150000000000 9.54230000000000 9.67320000000000 9.80400000000000 9.93490000000000 10.0657000000000 10.1966000000000 10.3274000000000 10.4583000000000 10.5891000000000 10.7200000000000 10.8508000000000 10.9816000000000 11.1125000000000 11.2433000000000 11.3742000000000 11.5050000000000 11.6359000000000 11.6369000000000 11.7045000000000 11.7725000000000 11.8409000000000 11.9097000000000 11.9789000000000 12.0485000000000 12.1185000000000 12.1889000000000 12.2597000000000 12.3309000000000 12.4026000000000 12.4746000000000 12.5471000000000 12.6200000000000 12.6933000000000 12.7671000000000 12.8413000000000 12.9159000000000 12.9909000000000 13.0664000000000 13.1423000000000 13.2186000000000 13.2954000000000 13.3727000000000 13.4504000000000 13.5285000000000 13.6071000000000 13.6862000000000 13.7657000000000 13.8457000000000 13.9261000000000 14.0070000000000 14.0884000000000 14.1703000000000 14.2526000000000 14.3354000000000 14.4187000000000 14.5025000000000 14.5867000000000 14.6715000000000 14.7567000000000 14.8425000000000 14.9287000000000 15.0154000000000 15.1027000000000 15.1904000000000 15.2787000000000 15.3674000000000 15.4567000000000 15.5465000000000 15.6368000000000 15.7277000000000 15.8191000000000 15.9110000000000 16.0034000000000 16.0964000000000 16.1899000000000 16.2840000000000 16.3786000000000 16.4738000000000 16.5695000000000 16.6657000000000 16.7626000000000 16.8600000000000 16.9579000000000 17.0564000000000 17.1555000000000 17.2552000000000 17.3555000000000 17.4563000000000 17.5577000000000 17.6597000000000 17.7623000000000 17.8655000000000 17.9693000000000 18.0737000000000 18.1787000000000 18.2843000000000 18.3906000000000 18.4974000000000 18.6049000000000 18.7130000000000 18.8217000000000 18.9311000000000 19.0411000000000 19.1517000000000 19.2630000000000 19.3749000000000 19.4874000000000 19.6007000000000 19.7145000000000 19.8291000000000 19.9443000000000 20.0602000000000 20.1767000000000 20.2939000000000 20.4118000000000 20.5304000000000 20.6497000000000 20.7697000000000 20.8904000000000 21.0117000000000 21.1338000000000 21.2566000000000 21.3801000000000 21.5043000000000 21.6293000000000 21.7549000000000 21.8813000000000 22.0084000000000 22.1363000000000 22.2649000000000 22.3943000000000 22.5244000000000 22.6553000000000 22.7869000000000 22.9193000000000 23.0524000000000 23.1864000000000 23.3211000000000 23.4566000000000 23.5929000000000 23.7299000000000 23.8678000000000 24.0065000000000 24.1460000000000 24.2862000000000 24.4273000000000 24.5693000000000 24.7120000000000 24.8556000000000 25 25.0010000000000];
Cpfun = @(ws) interp1(wind_speed, cp, ws);
Ctfun = @(ws) interp1(wind_speed, ct, ws);

% Wake centerline is at y=40, z=10
mu = [40, 10];
% Compute Velocity profile at x0 (see Porte-Agel/Bastankhah)
coVarMat = [cos(yaw)*R/sqrt(2) 0; 0 R/sqrt(2)].^2;

% Compute the velocity deficit at a downwind rotor for multiple gridSizes
gridSizes = .1:.1:20;
P1 = gridSizes.*0;
P2 = gridSizes.*0;
for i = 1:length(gridSizes)
    % Define a grid to compute the velocity deficit
    lims = 120;
    y = -lims:gridSizes(i):lims;
    z = -lims:gridSizes(i):lims;
    [Y,Z] = meshgrid(y,z);

    % Initial V deficit based on Ct
    C0 = 1-sqrt(1-Ctfun(V0));
    % Compute the velocity profile as a bivariate gaussian
    F = V0*(1-C0*exp(-0.5*((Y-mu(1))/(cos(yaw)*R/sqrt(2))).^2).*exp(-0.5*((Z-mu(2))/(R/sqrt(2))).^2));

    % Probe which points hit the downwind turbine
    VatRotor = F(hypot(Y,Z)<R);
    % Compute the power at each gridpoint and take the mean
    P1(i) = mean(0.5*rho*pi*R*R*Cpfun(VatRotor).*(VatRotor.^3));
    % Take the mean and compute the power
    meanV = mean(VatRotor);
    P2(i) = 0.5*rho*pi*R*R*Cpfun(meanV).*(meanV.^3);
    
    % Plot a downwind turbine and the wake velocity profile for GS = [1 10 20]
    if any(gridSizes(i) == [1 10 20])
        figure
        surf(y,z,F,'edgecolor','none');
        hold on
        % Define a cylinder to display a second turbine
        [Xc,Yc,Zc] = cylinder(R);
        surf(Xc,Yc,Zc*max(F(:)))
        daspect([1,1,.05])
        caxis([min(F(:))-.5*range(F(:)),max(F(:))]);
        xlabel('Y[m]'); ylabel('Z[m]'); zlabel('V[m/s]');
    end
end
% Plot the two power predicitions
figure
plot(gridSizes, P1, gridSizes, P2)
title('Two methods to compute the power of a downwind rotor')
xlabel('gridsize used to probe wake [m]')
ylabel('Predicted Power [W]')
